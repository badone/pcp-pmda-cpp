language: cpp

compiler:
  - clang
  - gcc

env:
  global:
   # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
   #   via the "travis encrypt" command using the project repo's public key
   - secure: "P9gHn+wkHWzjRqcwlcCoSGmz8pw1aG3CwuPP0rsMpqsa+jh0lr3SDfdA01Xll68Rb7xY7yVTtXaFOXrEk6ceb3fvGs4JxYXNXRgkG8uF808Lm19bbADAQBb5kXECiClaLKk20es/Y4mlI6G/8Qmr4OmOc0Z2gL/sVqLnh6QLTtI="

addons:
  coverity_scan:
    project:
      name: "pcolby/pcp-pmda-cpp"
      description: "Build submitted via Travis CI"
    notification_email: git@colby.id.au
    build_command_prepend: >
      mkdir -p $TRAVIS_BUILD_DIR-scan &&
      pushd $TRAVIS_BUILD_DIR-scan &&
      cmake $TRAVIS_BUILD_DIR
    build_command: make
    branch_pattern: coverity_scan

before_install:
  - sudo apt-get update -qq

install:
  - >
    sudo apt-get install -qq
    cppcheck
    libboost-program-options-dev
    libpcp3 libpcp3-dev libpcp-pmda3 libpcp-pmda3-dev
    pcp
    rubygems
  - if [ "$CXX" = "g++" ]; then sudo apt-get install lcov; fi
  - gem install lcoveralls

before_script:
  - mkdir -p $TRAVIS_BUILD_DIR-build

script:
  - cppcheck --error-exitcode=1 --quiet .
  - pushd $TRAVIS_BUILD_DIR-build
  - cmake $TRAVIS_BUILD_DIR && make check
  - if [ "$CXX" = "g++" ]; then make coverage; fi
  - popd

after_success:
  - if [ "$CXX" = "g++" ]; then lcoveralls --retry-count 5 --root $TRAVIS_BUILD_DIR; fi
